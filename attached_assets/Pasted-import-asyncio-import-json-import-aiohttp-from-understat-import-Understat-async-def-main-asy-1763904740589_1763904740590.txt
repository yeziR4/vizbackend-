import asyncio
import json
import aiohttp
from understat import Understat

async def main():
    async with aiohttp.ClientSession() as session:
        understat = Understat(session)
        
        # Updated for 2025-2026 Premier League season
        # Note: Understat typically uses the year the season starts
        season_year = 2025
        
        print(f"Fetching Premier League {season_year}-{season_year+1} season data...")
        
        goals_data = []
        
        try:
            # Fetch all match results for the season
            results = await understat.get_league_results("EPL", season_year)
            
            print(f"Found {len(results)} matches. Fetching shots for each match...")
            
            for idx, match in enumerate(results, 1):
                match_id = match['id']
                match_date = match.get('datetime', 'Unknown date')
                
                print(f"Processing match {idx}/{len(results)}: {match['h']['title']} vs {match['a']['title']} ({match_date})")
                
                try:
                    shots = await understat.get_match_shots(match_id)
                    
                    # Combine home and away shots
                    all_shots = shots['h'] + shots['a']
                    
                    for shot in all_shots:
                        if shot['result'] == 'Goal':
                            goals_data.append({
                                "id": shot['id'],
                                "x": float(shot['X']),  # 0 to 1 (0 = own goal line, 1 = opponent goal line)
                                "y": float(shot['Y']),  # 0 to 1 (0 = left touchline, 1 = right touchline)
                                "player": shot['player'],
                                "minute": shot['minute'],
                                "match_id": match_id,
                                "team": shot['h_team'] if shot['h_a'] == 'h' else shot['a_team'],
                                "opponent": shot['a_team'] if shot['h_a'] == 'h' else shot['h_team'],
                                "xg": float(shot['xG']),  # Expected goals value
                                "situation": shot.get('situation', 'Unknown'),
                                "shotType": shot.get('shotType', 'Unknown'),
                                "match_date": match_date
                            })
                    
                    # Small delay to avoid overwhelming the server
                    await asyncio.sleep(0.5)
                    
                except Exception as e:
                    print(f"Error fetching shots for match {match_id}: {e}")
                    continue
            
            # Save to a JSON file for your frontend
            output_file = f'premier_league_goals_{season_year}_{season_year+1}.json'
            with open(output_file, 'w', encoding='utf-8') as f:
                json.dump(goals_data, f, indent=2, ensure_ascii=False)
            
            print(f"\n‚úÖ Success! Data saved to {output_file}")
            print(f"üìä Total goals collected: {len(goals_data)}")
            
            # Print some statistics
            if goals_data:
                teams = set(goal['team'] for goal in goals_data)
                print(f"üèüÔ∏è Teams: {len(teams)}")
                print(f"‚öΩ Average xG per goal: {sum(g['xg'] for g in goals_data) / len(goals_data):.3f}")
        
        except Exception as e:
            print(f"‚ùå Error fetching league data: {e}")
            print("\nPossible reasons:")
            print("1. The 2025-2026 season data might not be available yet on Understat")
            print("2. Try using season year 2024 for the 2024-2025 season")
            print("3. Check if Understat API has changed")
            return

if __name__ == "__main__":
    asyncio.run(main())
